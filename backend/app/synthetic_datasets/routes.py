"""Synthetic Datasets API Routes."""

# ============================================================================
# IMPORTS
# ============================================================================

# Standard library
from typing import List
import uuid

# Third-party
from fastapi import APIRouter, Depends, HTTPException, status
from fastapi.responses import FileResponse
from sqlmodel import Session
from pathlib import Path

# Local - Core
from app.core.dependencies import get_db, get_current_user
from app.core.config import settings

# Local - Datasets (reuse Dataset model)
from app.datasets.models import Dataset
from app.datasets.schemas import DatasetResponse

# Local - Module
from .repositories import (
    list_synthetic_datasets,
    get_synthetic_dataset_by_id,
    delete_synthetic_dataset
)

# ============================================================================
# SETUP
# ============================================================================

router = APIRouter(prefix="/synthetic-datasets", tags=["synthetic-datasets"])

# ============================================================================
# ENDPOINTS
# ============================================================================

@router.get("/", response_model=List[DatasetResponse])
def list_synthetic(
    db: Session = Depends(get_db),
    current_user = Depends(get_current_user)
):
    """
    List all synthetic datasets.
    
    Returns all datasets that were generated by generators.
    """
    datasets = list_synthetic_datasets(db)
    # Filter to only synthetic ones (those created by generators, not uploaded)
    # We can identify them by checking if they have a generator_id or specific naming
    synthetic = [d for d in datasets if 'synthetic' in d.name.lower() or 'generated' in d.name.lower()]
    return synthetic


@router.get("/{dataset_id}", response_model=DatasetResponse)
def get_synthetic_dataset(
    dataset_id: str,
    db: Session = Depends(get_db),
    current_user = Depends(get_current_user)
):
    """Get a specific synthetic dataset by ID."""
    try:
        dataset_uuid = uuid.UUID(dataset_id)
    except ValueError:
        raise HTTPException(status_code=400, detail="Invalid UUID format")
    
    dataset = get_synthetic_dataset_by_id(db, dataset_uuid)
    if not dataset:
        raise HTTPException(status_code=404, detail="Synthetic dataset not found")
    
    return dataset


@router.get("/{dataset_id}/download")
def download_synthetic_dataset(
    dataset_id: str,
    db: Session = Depends(get_db),
    current_user = Depends(get_current_user)
):
    """Download a synthetic dataset file."""
    try:
        dataset_uuid = uuid.UUID(dataset_id)
    except ValueError:
        raise HTTPException(status_code=400, detail="Invalid UUID format")
    
    dataset = get_synthetic_dataset_by_id(db, dataset_uuid)
    if not dataset:
        raise HTTPException(status_code=404, detail="Synthetic dataset not found")
    
    # Get file path
    upload_dir = Path(settings.upload_dir)
    file_path = upload_dir / dataset.original_filename
    
    if not file_path.exists():
        raise HTTPException(
            status_code=404,
            detail=f"File not found: {dataset.original_filename}"
        )
    
    return FileResponse(
        path=file_path,
        filename=dataset.name,
        media_type='text/csv'
    )


@router.delete("/{dataset_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_synthetic(
    dataset_id: str,
    db: Session = Depends(get_db),
    current_user = Depends(get_current_user)
):
    """Delete a synthetic dataset."""
    try:
        dataset_uuid = uuid.UUID(dataset_id)
    except ValueError:
        raise HTTPException(status_code=400, detail="Invalid UUID format")
    
    # Get dataset first to check if it exists and delete file
    dataset = get_synthetic_dataset_by_id(db, dataset_uuid)
    if not dataset:
        raise HTTPException(status_code=404, detail="Synthetic dataset not found")
    
    # Delete physical file if it exists
    if dataset.original_filename:
        upload_dir = Path(settings.upload_dir)
        file_path = upload_dir / dataset.original_filename
        if file_path.exists():
            file_path.unlink()
    
    # Delete from database
    success = delete_synthetic_dataset(db, dataset_uuid)
    if not success:
        raise HTTPException(status_code=500, detail="Failed to delete dataset")
    
    return None
